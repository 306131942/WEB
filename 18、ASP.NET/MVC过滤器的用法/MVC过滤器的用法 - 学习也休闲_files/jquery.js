(function(c){c.fn.extend({autocomplete:function(a,b){var p="string"==typeof a,b=c.extend({},c.Autocompleter.defaults,{url:p?a:null,data:p?null:a,delay:p?c.Autocompleter.defaults.delay:10,max:b&&!b.scroll?10:150},b);b.highlight=b.highlight||function(a){return a};b.formatMatch=b.formatMatch||b.formatItem;return this.each(function(){new c.Autocompleter(this,b)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});c.Autocompleter=function(a,b){function p(){var t=k.selected();if(!t)return!1;var d=t.result;l=d;if(b.multiple){var e=o(f.val());if(1<e.length){var h=b.multipleSeparator.length,i=c(a).selection().start,j,g=0;c.each(e,function(a,b){g+=b.length;if(i<=g)return j=a,!1;g+=h});e[j]=d;d=e.join(b.multipleSeparator)}d+=b.multipleSeparator}f.val(d);n();f.trigger("result",[t.data,t.value]);
return!0}function m(a,c){if(u==h.DEL)k.hide();else{var i=f.val();if(c||i!=l)l=i,i=g(i),i.length>=b.minChars?(f.addClass(b.loadingClass),b.matchCase||(i=i.toLowerCase()),e(i,d,n)):(f.removeClass(b.loadingClass),k.hide())}}function o(a){return!a?[""]:!b.multiple?[c.trim(a)]:c.map(a.split(b.multipleSeparator),function(b){return c.trim(a).length?c.trim(b):null})}function g(d){if(!b.multiple)return d;var i=o(d);if(1==i.length)return i[0];i=c(a).selection().start;i=i==d.length?o(d):o(d.replace(d.substring(i),
""));return i[i.length-1]}function n(){k.visible();k.hide();clearTimeout(q);f.removeClass(b.loadingClass);b.mustMatch&&f.search(function(a){a||(b.multiple?(a=o(f.val()).slice(0,-1),f.val(a.join(b.multipleSeparator)+(a.length?b.multipleSeparator:""))):(f.val(""),f.trigger("result",null)))})}function d(d,e){if(e&&e.length&&i){f.removeClass(b.loadingClass);k.display(e,d);var j=e[0].value;b.autoFill&&(g(f.val()).toLowerCase()==d.toLowerCase()&&u!=h.BACKSPACE)&&(f.val(f.val()+j.substring(g(l).length)),
c(a).selection(l.length,l.length+j.length));k.show()}else n()}function e(d,i,e){b.matchCase||(d=d.toLowerCase());var h=j.load(d);if(h&&h.length)i(d,h);else if("string"==typeof b.url&&0<b.url.length){var f={timestamp:+new Date};c.each(b.extraParams,function(a,d){f[a]="function"==typeof d?d():d});c.ajax({mode:"abort",port:"autocomplete"+a.name,dataType:b.dataType,url:b.url,data:c.extend({q:g(d),limit:b.max},f),success:function(a){var e;if(!(e=b.parse&&b.parse(a))){e=[];for(var a=a.split("\n"),h=0;h<
a.length;h++){var f=c.trim(a[h]);f&&(f=f.split("|"),e[e.length]={data:f,value:f[0],result:b.formatResult&&b.formatResult(f,f[0])||f[0]})}}j.add(d,e);i(d,e)}})}else k.emptyList(),e(d)}var h={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},f=c(a).attr("autocomplete","off").addClass(b.inputClass),q,l="",j=c.Autocompleter.Cache(b),i=0,u,s={mouseDownOnSelect:!1},k=c.Autocompleter.Select(b,a,p,s),r;c.browser.opera&&c(a.form).bind("submit.autocomplete",function(){if(r)return r=
!1});f.bind((c.browser.opera?"keypress":"keyup")+".autocomplete",function(a){i=1;u=a.keyCode;switch(a.keyCode){case h.UP:a.preventDefault();k.visible()?k.prev():m(0,!0);break;case h.DOWN:a.preventDefault();k.visible()?k.next():m(0,!0);break;case h.PAGEUP:a.preventDefault();k.visible()?k.pageUp():m(0,!0);break;case h.PAGEDOWN:a.preventDefault();k.visible()?k.pageDown():m(0,!0);break;case b.multiple&&","==c.trim(b.multipleSeparator)&&h.COMMA:case h.TAB:case h.RETURN:if(p())return a.preventDefault(),
r=!0,!1;break;case h.ESC:k.hide();break;default:clearTimeout(q),q=setTimeout(m,b.delay)}}).focus(function(){i++}).blur(function(){i=0;s.mouseDownOnSelect||(clearTimeout(q),q=setTimeout(n,200))}).click(function(){1<i++&&!k.visible()&&m(0,!0)}).bind("search",function(){function a(b,e){var i;if(e&&e.length)for(var c=0;c<e.length;c++)if(e[c].result.toLowerCase()==b.toLowerCase()){i=e[c];break}"function"==typeof d?d(i):f.trigger("result",i&&[i.data,i.value])}var d=1<arguments.length?arguments[1]:null;
c.each(o(f.val()),function(d,b){e(b,a,a)})}).bind("flushCache",function(){j.flush()}).bind("setOptions",function(a,d){c.extend(b,d);"data"in d&&j.populate()}).bind("unautocomplete",function(){k.unbind();f.unbind();c(a.form).unbind(".autocomplete")})};c.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},
formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,b){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};c.Autocompleter.Cache=function(a){function b(d,b){a.matchCase||(d=d.toLowerCase());var c=d.indexOf(b);"word"==a.matchContains&&(c=d.toLowerCase().search("\\b"+b.toLowerCase()));return-1==c?!1:0==c||a.matchContains}function p(d,
b){n>a.cacheLength&&o();g[d]||n++;g[d]=b}function m(){if(!a.data)return!1;var d={},b=0;a.url||(a.cacheLength=1);d[""]=[];for(var h=0,f=a.data.length;h<f;h++){var g=a.data[h],g="string"==typeof g?[g]:g,l=a.formatMatch(g,h+1,a.data.length);if(!1!==l){var j=l.charAt(0).toLowerCase();d[j]||(d[j]=[]);g={value:l,data:g,result:a.formatResult&&a.formatResult(g)||l};d[j].push(g);b++<a.max&&d[""].push(g)}}c.each(d,function(d,b){a.cacheLength++;p(d,b)})}function o(){g={};n=0}var g={},n=0;setTimeout(m,25);return{flush:o,
add:p,populate:m,load:function(d){if(!a.cacheLength||!n)return null;if(!a.url&&a.matchContains){var e=[],h;for(h in g)if(0<h.length){var f=g[h];c.each(f,function(a,c){b(c.value,d)&&e.push(c)})}return e}if(g[d])return g[d];if(a.matchSubset)for(h=d.length-1;h>=a.minChars;h--)if(f=g[d.substr(0,h)])return e=[],c.each(f,function(a,c){b(c.value,d)&&(e[e.length]=c)}),e;return null}}};c.Autocompleter.Select=function(a,b,p,m){function o(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return!a?[]:a}function g(b){d.slice(e,
e+1).removeClass(n.ACTIVE);e+=b;0>e?e=d.size()-1:e>=d.size()&&(e=0);b=d.slice(e,e+1).addClass(n.ACTIVE);if(a.scroll){var c=0;d.slice(0,e).each(function(){c+=this.offsetHeight});c+b[0].offsetHeight-j.scrollTop()>j[0].clientHeight?j.scrollTop(c+b[0].offsetHeight-j.innerHeight()):c<j.scrollTop()&&j.scrollTop(c)}}var n={ACTIVE:"ac_over"},d,e=-1,h,f="",q=!0,l,j;return{display:function(b,g){q&&(l=c("<div/>").hide().addClass(a.resultsClass).css("position","absolute").appendTo(document.body),j=c("<ul/>").appendTo(l).mouseover(function(a){o(a).nodeName&&
"LI"==o(a).nodeName.toUpperCase()&&(e=c("li",j).removeClass(n.ACTIVE).index(o(a)),c(o(a)).addClass(n.ACTIVE))}).click(function(a){c(o(a)).addClass(n.ACTIVE);p();return!1}).mousedown(function(){m.mouseDownOnSelect=!0}).mouseup(function(){m.mouseDownOnSelect=!1}),0<a.width&&l.css("width",a.width),q=!1);h=b;f=g;j.empty();for(var s=a.max&&a.max<h.length?a.max:h.length,k=0;k<s;k++)if(h[k]){var r=a.formatItem(h[k].data,k+1,s,h[k].value,f);!1!==r&&(r=c("<li/>").html(a.highlight(r,f)).addClass(0==k%2?"ac_even":
"ac_odd").appendTo(j)[0],c.data(r,"ac_data",h[k]))}d=j.find("li");a.selectFirst&&(d.slice(0,1).addClass(n.ACTIVE),e=0);c.fn.bgiframe&&j.bgiframe()},next:function(){g(1)},prev:function(){g(-1)},pageUp:function(){0!=e&&0>e-8?g(-e):g(-8)},pageDown:function(){e!=d.size()-1&&e+8>d.size()?g(d.size()-1-e):g(8)},hide:function(){l&&l.hide();d&&d.removeClass(n.ACTIVE);e=-1},visible:function(){return l&&l.is(":visible")},current:function(){return this.visible()&&(d.filter("."+n.ACTIVE)[0]||a.selectFirst&&d[0])},
show:function(){var e=c(b).offset();l.css({width:"string"==typeof a.width||0<a.width?a.width:c(b).width(),top:e.top+b.offsetHeight,left:e.left}).show();if(a.scroll&&(j.scrollTop(0),j.css({maxHeight:a.scrollHeight,overflow:"auto"}),c.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var f=0;d.each(function(){f+=this.offsetHeight});e=f>a.scrollHeight;j.css("height",e?a.scrollHeight:f);e||d.width(j.width()-parseInt(d.css("padding-left"))-parseInt(d.css("padding-right")))}},selected:function(){var a=
d&&d.filter("."+n.ACTIVE).removeClass(n.ACTIVE);return a&&a.length&&c.data(a[0],"ac_data")},emptyList:function(){j&&j.empty()},unbind:function(){l&&l.remove()}}};c.fn.selection=function(a,b){if(void 0!==a)return this.each(function(){if(this.createTextRange){var c=this.createTextRange();void 0===b||a==b?c.move("character",a):(c.collapse(!0),c.moveStart("character",a),c.moveEnd("character",b));c.select()}else this.setSelectionRange?this.setSelectionRange(a,b):this.selectionStart&&(this.selectionStart=
a,this.selectionEnd=b)});var c=this[0];if(c.createTextRange){var m=document.selection.createRange(),o=c.value,g=m.text.length;m.text="<->";m=c.value.indexOf("<->");c.value=o;this.selection(m,m+g);return{start:m,end:m+g}}if(void 0!==c.selectionStart)return{start:c.selectionStart,end:c.selectionEnd}}})(jQuery);